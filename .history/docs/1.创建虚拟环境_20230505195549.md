# Django

# 虚拟环境搭建

### 10.1.1 安装虚拟环境

#### windows 下安装

1. 安装 `virtualenvwrapper-win`

   ```bash
   pip3 install virtualenvwrapper-win
   ```

2. 重新打开`cmd` 或 `powerShell` ，创建虚拟环境

   ```bash
   mkvirtualenv -p python3 虚拟环境名称
   ```

#### ubuntu 下安装

1. 安装

   ```bash
   pip install virtualenv
   pip install virtualenvwrapper
   ```

​  `virtualenv`是虚拟环境，`virtualenvwrapper`对`virtualenv`的命令进行了封装，使得其更加友好。

​  安装的顺序不能颠倒，`virtualenvwrapper`必须依赖于`virtualenv`  

2. 在 `~/.bashrc` 下配置环境变量  

   ```bash
   # 配置 python 虚拟环境变量
   export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3
   # 所有虚拟环境存储的目录
   export WORKON_HOME=$HOME/.virtualenvs
   source /home/zp/.local/bin/virtualenvwrapper.sh
   ```

   退出 `~/.bashrc`，执行 `source .bashrc`，使设置的环境变量生效

3. 测试是否安装成功

​  使用 `mkvirtualenv -p python3 test` 命令在 `~/.virtualenvs` 创建一个目录为`test`的虚拟环境。

​  如果提示 `ERROR: virtualenvwrapper could not find virtualenv in your path`，使用 `sudo apt install virtualenv` 重新安装下，就可以了。

### 10.1.2 虚拟环境的操作命令

* 查看所有虚拟环境

  ```bash
  workon
  ```

* 切换/进入虚拟环境

  ```bash
  workon NAME
  ```

* 删除虚拟环境

  ```bash
  rmvirtualenv NAME
  ```

* 退出虚拟环境

  ```bash
  deactivate
  ```

### 10.1.3 虚拟环境依赖包安装

* 安装`Django`

  ```bash
  pip install django==2.2.5
  ```

  注意：这里不能使用 `sudo` 命令，否则安装到的不是虚拟环境下的目录

* 查看环境内已安装包

  ```bash
  pip list
  ```

## 10.2 创建 Django 项目

### 10.2.1 创建项目

```bash
django-admin startproject name

# 目录结构
├─src
│ ├─settings.py  项目整体的配置文件
│ ├─urls.py      项目的URL配置文件
│ ├─wsgi.py      项目与WSGI兼容的Web服务器入口
│ └─__init__.py  
└─manage.py      项目管理文件，通过它管理项目

# 运行项目
python manage.py runserver
```

### 10.2.2 创建子应用

```bash
python manager.py startapp name
```

### 10.2.3 注册子应用

在 `settings.py` 里注册

## 10.3 模型

### 10.3.1 使用 Django 进行数据库开发的步骤

#### 1. 定义模型

```python
class BookInfo(models.Model):
    name = models.CharField(max_length=10)

class PeopleInfo(models.Model):
    name = models.CharField(max_length=10)
    gender = models.BooleanField()
    # 外键约束：人物属于哪本书
    book = models.ForeignKey(BookInfo, on_delete=models.CASCADE)
```

#### 2. 模型迁移（建表）

##### 迁移由两步完成

###### 生成迁移文件：根据模型类生成创建表的语句（需要在`settings.py`里先注册子应用）

```python
python manage.py makemigrations
```

###### 执行迁移文件：根据第一步生成的语句在数据库中创建表

```python
python manage.py migrate
```

#### 3. 操作数据库

<https://blog.csdn.net/An_muyan/article/details/120242796>

<https://blog.csdn.net/weixin_44107321/article/details/119116833>

## 10.4 站点管理

### 10.4.1 管理界面本地化

1. 启动项目下的 `manage.py` 文件

2. 访问 `http://127.0.0.1:8000/admin` 进入登录页面

   界面默认是英文，需要改为中文，需要在 `/项目名称/settings.py` 里进行修改

   ```python
   # settings.py
   
   # 设置语言
   # LANGUAGE_CODE = 'en-us'
   LANGUAGE_CODE = 'zh-Hans'
   
   # 设置时区
   # TIME_ZONE = 'UTC'
   TIME_ZONE = 'Asia/Shanghai'
   ```

### 10.4.2 创建管理员

1. 运行`python manage.py createsuperuser` 创建超级用户的 账号、密码和邮箱

   这样就会在表 `db.sqlite3/Schemas/main/Tables/auth_user` 生成一条数据

   重置密码使用 `python manager.py changepassword 用户名`

2. 在登录页面用刚才设置的账号密码进行登录

### 10.4.3 注册模型类

```python
# /src/book/admin.py
from django.contrib import admin

from book.models import BookInfo, PeopleInfo
# 注册模型类
admin.site.register(BookInfo)
admin.site.register(PeopleInfo)
# 重启Django
```

### 10.4.4 发布内容到数据库

## 10.5 视图和路由

### 10.5.1 视图

```python
# /src/book/views.py
from django.shortcuts import render
from django.http import HttpRequest
from django.http import HttpResponse
# Create your views here.
"""
视图
所谓的视图 其实就是python函数
视图函数有2个要求：
    1. 视图函数的第一个参数就是接收请求。这个请求其实就是 HttpRequest 的类对象
    2. 必须返回一个响应
"""
def index():
    return HttpResponse('ok')
```

### 10.5.2 路由

在子应用创建`urls.py`

```python
# /src/book/urls.py
from django.urls import path
from book.views import index
# urlpatterns 是固定写法
urlpatterns = [
    # path('路由'，'视图函数名')
    path('index/', index)
]
```

```python
from django.contrib import admin
from django.urls import path, include
urlpatterns = [
    path('admin/', admin.site.urls),
    path('book/', include('book.urls'))
]
```

## 10.6 模板 Template

在`/src/settings.py` 文件下的 `TEMPLATE` 变量里的 `DIRS` 属性里设置模板路径，例如：

```python
TEMPLATES = [{
    ...,
    # 告知系统，我们的模板文件放在哪里
    'DIRS': [os.path.join(BASE_DIR, 'templates')],
    ...
}]
```

将 `/src/book/views.py` 里的 `def index` 改为：

```python
def index(request):
    # return HttpResponse('ok')
    context = {
        'name': '马上双11'
    }
    return render(request, 'book/index.html', context=context)
```

## 10.7 配置文件 `/src/settings.py`

* `BASE_DIR`

  ```python
  BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
  
  # print(__file__)
  # C:\Users\Administrator\Envs\vir1\src\src\settings.py
  # print(os.path.abspath(__file__))
  # C:\Users\Administrator\Envs\vir1\src\src\settings.py
  # os.path.dirname() 获取文件的目录
  # print(os.path.dirname(os.path.abspath(__file__)))
  # C:\Users\Administrator\Envs\vir1\src\src
  ```

* `DEBUG = True` 调试模式、 `ALLOWED_HOSTS`

  在我们开发的时候，我们需要看到更多的信息，所以要开启debug模式，当我们的程序上线之后，就改为False，此时，必须在 `ALLOWED_HOSTS` 里设置可访问的 `ip` 地址

* 语言与时区

  ```python
  # 设置语言
  # LANGUAGE_CODE = 'en-us'
  LANGUAGE_CODE = 'zh-Hans'
  
  # 设置时区
  # TIME_ZONE = 'UTC'
  TIME_ZONE = 'Asia/Shanghai'
  ```

## 10.8 静态文件

为了提供静态文件，需要在`/src/settings.py`配置两个参数：

```python
# 存放查找静态文件的目录
STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')]
# 访问静态文件的URL前缀
STATIC_URL = '/static/'
```

在浏览器访问：`http://127.0.0.1:8000/static/c.png`

## 10.9 App 应用配置

## 10.10 更换数据库

### 10.10. 1 在 MySQL 中创建数据库

```mysql
create database book charset utf8;
use book;
```

### 10.10.2 修改 DATABASES 配置信息

修改 `settings.py` 中的 `DATABASES`：

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'HOST': '127.0.0.1',     # 主机
        'PORT': 3306,            # 端口号
        'USER': 'root',          # 用户名
        'PASSWORD': 'root',      # 密码
        'NAME': 'book',          # 数据库
    }
}
```

### 10.10.3 运行测试

报错：

> `django.core.exceptions.ImproperlyConfigured: Error loading MySQLdb module.
> Did you install mysqlclient?`

原因：没有安装 `mysqlclient`

在虚拟环境中安装 `mysqlclient`

```bash
pip install mysqlclient
```

> 如果`pip install mysqlclient` 报错，需要在当前操作系统中安装 `libmysqlclient-dev`：
>
> `sudo apt-get install libmysqlclient-dev`
